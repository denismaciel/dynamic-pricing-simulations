library(tidyverse)

FIGS_FOLDER <- fs::path("figs")

df <- list.files('simulations/exploration_exploitation/data', pattern = '*.csv', full.names = TRUE) %>%
  map(
    function(x) read_csv(x) %>%
        mutate(experiment = fs::path_file(x) %>% stringr::str_remove(".csv"))
  ) %>%
  bind_rows


# Total revenue
plot_total_revenue <- df %>% 
  group_by(experiment, trial_id) %>% 
  summarise(revenue = sum(revenue)) %>% 
  ggplot(aes(experiment, revenue, color=experiment)) +
  geom_boxplot() +
  labs(x = NULL, y = "Total Revenue") +
  theme_light() +
  theme(legend.position = "none") +
  coord_flip()

plot_total_revenue
ggsave(
  plot = plot_total_revenue,
  FIGS_FOLDER / 'exploration_exploitation_total_revenue.png',
  width = 13,
  height = 6,
  units = 'cm'
)

df %>% 
  group_by(experiment, trial_id) %>% 
  summarise(revenue = sum(revenue)) %>% 
  group_by(experiment) %>% 
  summarise(avg_revenue = mean(revenue))

# Revenue over time
df %>% 
  group_by(experiment, period_id) %>% 
  summarise(avg_revenue = mean(revenue)) %>% 
  ggplot(aes(period_id, avg_revenue, color = experiment)) +
  geom_line()


# How often each price was picked in every period
plot_ppchosen <- df %>% 
  count(experiment, period_id, price) %>%
  group_by(experiment, period_id) %>% 
  mutate(pp_chosen = n / sum(n)) %>% 
  ggplot(aes(period_id, pp_chosen, color = factor(price))) +
  geom_line() +
  facet_grid(experiment ~ .) +
  labs(color = "Price", x = "Period", y = NULL) +
  theme_light() +
  theme(legend.position = 'bottom')

plot_ppchosen
ggsave(
  plot = plot_ppchosen,
  FIGS_FOLDER / 'exploration_exploitation_pp_price_chosen_per_period.png',
  width = 13,
  height = 10,
  units = 'cm'
)
# Change of beliefs about prices over time
# x <- df %>% 
#   filter(period_id %in% c(0, 100, 250, 499)) %>% 
#   group_by(experiment, period_id) %>% 
#   summarise(across(c(ends_with('alpha'), ends_with('beta')), function(x) round(mean(x)))) %>% 
#   pivot_longer(cols=c(ends_with('alpha'), ends_with('beta')), names_to='price_param') %>% 
#   mutate(
#     price = str_extract(price_param, "\\d\\d\\.\\d"),
#     param = str_extract(price_param, "_\\w+") %>% str_remove("_")
#   ) %>% 
#   select(-price_param) %>% 
#   pivot_wider(names_from=param, values_from=value) %>% 
#   mutate(
#     points = map2(alpha, beta, function(alpha, beta) 
#       tibble(x = seq(0, 1, length=100)) %>% 
#                mutate(y = dbeta(x, alpha, beta)))
#   ) %>% 
#   unnest(cols = c(points)) %>% 
#   filter(experiment == 'greedy')
# 
# x %>% 
#   ggplot(aes(x, y, color=factor(period_id))) +
#   geom_line() +
#   facet_wrap(~ price, scales = 'free_y')
