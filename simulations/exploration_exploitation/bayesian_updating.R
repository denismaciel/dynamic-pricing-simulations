library(tidyverse)

set.seed(555)

FIGS_FOLDER <- fs::path("figs")

PURCHASE_PROBABILITY <- 0.7
PARAM_VALUES <- seq(0, 1, length = 1000)
ALPHA_PRIOR = 1
BETA_PRIOR = 1

# Starting point
prior <- tibble(
  alpha = ALPHA_PRIOR,
  beta = BETA_PRIOR,
  period = 0,
  purchase = NA,
  points = list(tibble(
    x = PARAM_VALUES, y = dbeta(PARAM_VALUES, alpha, beta)
  ))
)

# Simulations
posteriors <- tibble(purchase = rbinom(1000, 1, PURCHASE_PROBABILITY)) %>%
  mutate(
    period = row_number(),
    alpha = cumsum(purchase) + ALPHA_PRIOR,
    beta = period - cumsum(purchase) + BETA_PRIOR
  ) %>%
  mutate(points = map2(alpha, beta, function(alpha, beta)
    tibble(
      x = PARAM_VALUES, y = dbeta(PARAM_VALUES, alpha, beta)
    )))

simulation <- bind_rows(prior, posteriors) %>%
  unnest(points)

simulation %>%  
  group_by(period) %>%
  summarise(alpha = max(alpha), beta = max(beta)) %>%
  mutate(mean = alpha / (alpha + beta))

bayesian_updating <- simulation %>%
  filter(period %in% c(0, 20, 100, 1000)) %>% 
  ggplot(aes(x, y, color = factor(period))) +
  geom_line(alpha = 1 / 2) +
  scale_y_continuous() +
  geom_vline(xintercept = PURCHASE_PROBABILITY) +
  labs(x = expression(theta[j]), y = NULL, color = 'Period') +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text=element_text(size=8)
        )
bayesian_updating
ggsave(plot = bayesian_updating, FIGS_FOLDER / 'bayesian_updating.png', width = 10, height = 6, units = 'cm')


bayesian_updating2 <- bind_rows(prior, posteriors) %>% 
  mutate(prior = lag(points), posterior = points) %>%
  select(-points) %>% 
  filter(period %in% 1:9) %>% 
  mutate(posterior = map(posterior, function(posterior) {
    colnames(posterior) <- c('x_posterior', 'y_posterior')
    return(posterior)
  })) %>% 
  unnest(c(prior, posterior)) %>% 
  ggplot() +
  geom_line(aes(x_posterior, y_posterior), color='blue') +
  geom_line(aes(x, y), color='red') +
  geom_text(data=function(data) {
    data %>% 
      group_by(period) %>% 
      summarise(purchase = max(purchase))
  }, aes(x=0.05, y=2.4, label = if_else(as.logical(purchase), "✅", "❌")), size=3) +
  facet_wrap(~period)
bayesian_updating2
ggsave(plot = bayesian_updating2, FIGS_FOLDER / 'bayesian_updating2.png', width = 10, height = 6, units = 'cm')
